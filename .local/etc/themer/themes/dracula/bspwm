#!/usr/bin/env bash

source bootstrap.sh

include utils/_.sh
include utils/lemonbuddy.sh
include utils/json.sh

bootstrap::finish

size_border=4
size_gap=10

padding_top=32
padding_bottom=0
padding_left=0
padding_right=0

color_focused_border="#6162ae"
color_normal_border="#282a37"
color_active_border="#282a37"
color_presel_feedback="#9966cc"

lemonbuddy_config="$CURRENT_THEME/lemonbuddy.plain"
lemonbuddy_bars=(top)

theme::post_bspwmrc()
{
  [[ "$(xdo id -a lemonbuddy-top_eDP-1)" ]] || {
    _::stderr "Failed to get the lemonbar X Window ID"
    return 1
  }

  # main background
  lemonbuddy::drawline "$lemonbuddy_config" "top" "below" "#ff5f627a" 21 100% 0 0 'true'

  # right-side module rails
  #lemonbuddy::drawline "$lemonbuddy_config" "top" "below" "#22000000" 1 611 1309 5 'true'
  #lemonbuddy::drawline "$lemonbuddy_config" "top" "below" "#11ffffff" 1 610 1310 -5 'true'

  # bevel effect lines
  lemonbuddy::drawline "$lemonbuddy_config" "top" "below" "#dd45485f" 1 100% 0 23
  lemonbuddy::drawline "$lemonbuddy_config" "top" "below" "#22ffffff" 1 100% 0 24

  theme::draw_separators

  #"$XDG_CONFIG_HOME"/lemonbuddy/bin/autohide setup
}

theme::draw_separators() {
  local x_offset="${1:-0}"
  local x_pos=0
  local sep=0
  local step=37

  lname="$(lemonbuddy top -c "$config" --print-wmname)"

  while (( sep++ < 10 )); do
    x_pos=$(( sep * step ))

    [[ $sep -ge 10 ]] && {
      x_pos=$(( x_pos + 7 ))
    }

    pgrep -f "xdrawrect\-ws\-separator\-${sep}" 2>/dev/null | xargs kill 2>/dev/null

    xdrawrect eDP-1 top 1 20 $((x_offset+x_pos-1)) 8 "#33000000" "xdrawrect-ws-separator-${sep}a" "$lname" &
    xdrawrect eDP-1 top 1 20 $((x_offset+x_pos)) 8 "#11ffffff" "xdrawrect-ws-separator-${sep}b" "$lname" &
  done
}
